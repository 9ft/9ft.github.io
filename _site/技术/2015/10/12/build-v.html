<!DOCTYPE html> <html> <head> <meta charset="utf-8"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" /> <!--[if lte IE 9]><meta http-equiv="refresh" content="0;url=/ie.html"><![endif]--> <title>v_p_n 架设</title> <meta name="description" content="###架构&gt;- 使用 Openswan 作为 IPsec 服务器;&gt;- 使用 xl2tpd 提供 L2TP 支持;&gt;- 使用 ppp 提供用户认证"> <link href='http://fonts.googleapis.com/css?family=Open+Sans:400,400italic,600|Droid+Sans+Mono' rel='stylesheet' type='text/css'> <link rel="stylesheet" href="/css/main.css"> <link rel="canonical" href="http://yourdomain.com/%E6%8A%80%E6%9C%AF/2015/10/12/build-v.html"> <link rel="alternate" type="application/rss+xml" title="TechLog" href="http://yourdomain.com/feed.xml" /> <script src="/assets/js/prefixfree.js"></script> </head> <body> <aside id="sidebar"> <div id="sidebar-left"> <a id="sidebar-avatar" href="/"> <img id="sidebar-avatar-img" alt="" src="/assets/img/avatar.jpg"/> </a> <div id="sidebar-social"> <a href="/feed.xml" class="sidebar-social-icon feed"></a> <a href="mailto:mindycong@gmail.com" class="sidebar-social-icon email"></a> </div> <ul id="sidebar-tags"> <li class="sidebar-tag active" data-filter="all">全部文章</li> <li class="sidebar-tag" data-filter="技术">技术</li> </ul> </div> <div id="sidebar-right"> <div id="search-box"> <input id="search-input" type="text" placeholder="Search" /> </div> <nav id="toc"> <a class="toc-link" data-tags="技术" href="/%E6%8A%80%E6%9C%AF/2016/05/06/HEXO.html"> HEXO </a> <a class="toc-link" data-tags="技术" href="/%E6%8A%80%E6%9C%AF/2016/05/05/LNMP_on_Ubuntu.html"> Ubuntu 下安装 LNMP </a> <a class="toc-link" data-tags="技术" href="/%E6%8A%80%E6%9C%AF/2016/05/04/jekyll_nginx_on_VPS.html"> VPS上搭建 jekyll + nginx 博客 </a> <a class="toc-link" data-tags="技术" href="/%E6%8A%80%E6%9C%AF/2015/11/30/LAMP_Tomcat_FTP.html"> Ubuntu的LAMP+Tomcat+FTP安装 </a> <a class="toc-link" data-tags="技术" href="/%E6%8A%80%E6%9C%AF/2015/10/24/whow-to-run-cuda.html"> 运行第一个Cuda程序 </a> <a class="toc-link" data-tags="技术" href="/%E6%8A%80%E6%9C%AF/2015/10/22/x-window-fix.html"> Linux不能进入x window </a> <a class="toc-link" data-tags="技术" href="/%E6%8A%80%E6%9C%AF/2015/10/18/git-win-ssh.html"> Windows下使用Git的配置 </a> <a class="toc-link" data-tags="技术" href="/%E6%8A%80%E6%9C%AF/2015/10/17/sublime-config.html"> sublime 配置 </a> <a class="toc-link" data-tags="技术" href="/%E6%8A%80%E6%9C%AF/2015/10/14/ubuntu-installation.html"> Ubuntu 配置 </a> <a class="toc-link" data-tags="技术" href="/%E6%8A%80%E6%9C%AF/2015/10/12/build-v.html"> v_p_n 架设 </a> <a class="toc-link" data-tags="技术" href="/%E6%8A%80%E6%9C%AF/2015/10/12/build-ss.html"> ss搭建 </a> <a class="toc-link" data-tags="技术" href="/%E6%8A%80%E6%9C%AF/2015/10/11/Hello-World.html"> First Post </a> </nav> </div> </aside> <main id="main"> <article class="post container"> <div class="post-meta"> <span class="post-meta-span date">2015 October 12</span> </div> <h1 class="post-title">v_p_n 架设</h1> <p>###架构 &gt;- 使用 Openswan 作为 IPsec 服务器; &gt;- 使用 xl2tpd 提供 L2TP 支持; &gt;- 使用 ppp 提供用户认证</p> <p>###环境 &gt;- Linode &gt;- Ubuntu 14.04 64bit</p> <p>###架设步骤 <code class="highlighter-rouge"> sudo apt-get install openswan xl2tpd ppp lsof # 安装软件包，会有设置向导，全部 Enter 使用默认设置 </code></p> <p>##配置 ###防火墙 iptables 和 sysctl 的设置 ``` sudo iptables -t nat -A POSTROUTING -j SNAT –to-source %SERVERIP% -o eth+ #%SERVERIP% 替换成你的服务器 IP；eth+ 通配符</p> <table> <tbody> <tr> <td>echo “net.ipv4.ip_forward = 1”</td> <td>tee -a /etc/sysctl.conf</td> </tr> <tr> <td>echo “net.ipv4.conf.all.accept_redirects = 0”</td> <td>tee -a /etc/sysctl.conf</td> </tr> <tr> <td>echo “net.ipv4.conf.all.send_redirects = 0”</td> <td>tee -a /etc/sysctl.conf</td> </tr> <tr> <td>echo “net.ipv4.conf.default.rp_filter = 0”</td> <td>tee -a /etc/sysctl.conf</td> </tr> <tr> <td>echo “net.ipv4.conf.default.accept_source_route = 0”</td> <td>tee -a /etc/sysctl.conf</td> </tr> <tr> <td>echo “net.ipv4.conf.default.send_redirects = 0”</td> <td>tee -a /etc/sysctl.conf</td> </tr> <tr> <td>echo “net.ipv4.icmp_ignore_bogus_error_responses = 1”</td> <td>tee -a /etc/sysctl.conf</td> </tr> </tbody> </table> <p>for vpn in /proc/sys/net/ipv4/conf/*; do echo 0 &gt; $vpn/accept_redirects; echo 0 &gt; $vpn/send_redirects; done</p> <p>sysctl -p #应用设置 ```</p> <p>###添加自启 在<code class="highlighter-rouge">rc.local</code>中添加： <code class="highlighter-rouge"> for vpn in /proc/sys/net/ipv4/conf/*; do echo 0 &gt; $vpn/accept_redirects; echo 0 &amp;gt; $vpn/send_redirects; done iptables -t nat -A POSTROUTING -j SNAT --to-source %SERVERIP% -o eth+ </code></p> <p>###配置 Openswan (IPSEC) 在<code class="highlighter-rouge">/etc/ipsec.conf</code>中： 修改为<code class="highlighter-rouge">left=%SERVERIP%</code>、<code class="highlighter-rouge">protostack=netkey</code>。 <code class="highlighter-rouge">/etc/ipsec.conf</code>完整文件： ``` version 2.0 # conforms to second version of ipsec.conf specification</p> <h1 id="basic-configuration">basic configuration</h1> <p>config setup # Do not set debug options to debug configuration issues! # plutodebug / klipsdebug = “all”, “none” or a combation from below: # “raw crypt parsing emitting control klips pfkey natt x509 dpd private” # eg: # plutodebug=”control parsing” # Again: only enable plutodebug or klipsdebug when asked by a developer # # enable to get logs per-peer # plutoopts=”–perpeerlog” # # Enable core dumps (might require system changes, like ulimit -C) # This is required for abrtd to work properly # Note: incorrect SElinux policies might prevent pluto writing the core dumpdir=/var/run/pluto/ # # NAT-TRAVERSAL support, see README.NAT-Traversal nat_traversal=yes # exclude networks used on server side by adding %v4:!a.b.c.0/24 # It seems that T-Mobile in the US and Rogers/Fido in Canada are # using 25/8 as “private” address space on their 3G network. # This range has not been announced via BGP (at least upto 2010-12-21) virtual_private=%v4:10.0.0.0/8,%v4:192.168.0.0/16,%v4:172.16.0.0/12,%v4:25.0.0.0/8,%v6:fd00::/8,%v6:fe80::/10 # OE is now off by default. Uncomment and change to on, to enable. oe=off # which IPsec stack to use. auto will try netkey, then klips then mast protostack=netkey # Use this to log to a file, or disable logging on embedded systems (like openwrt) #plutostderrlog=/dev/null</p> <h1 id="add-connections-here">Add connections here</h1> <h1 id="sample-vpn-connection">sample VPN connection</h1> <p># for more examples, see /etc/ipsec.d/examples/ #conn sample # # Left security gateway, subnet behind it, nexthop toward right. # left=10.0.0.1 # leftsubnet=172.16.0.0/24 # leftnexthop=10.22.33.44 # # Right security gateway, subnet behind it, nexthop toward left. # right=10.12.12.1 # rightsubnet=192.168.0.0/24 # rightnexthop=10.101.102.103 # # To authorize this connection, but not actually start it, # # at startup, uncomment this. # #auto=add conn L2TP-PSK-noNAT authby=secret #shared secret. Use rsasig for certificates.</p> <div class="highlighter-rouge"><pre class="highlight"><code>pfs=no
#Disable pfs

auto=add
#the ipsec tunnel should be started and routes created when the ipsec daemon itself starts.

keyingtries=3
#Only negotiate a conn. 3 times.

ikelifetime=8h
keylife=1h

ike=aes256-sha1;modp1024!
phase2alg=aes256-sha1;modp1024
# specifies the phase 1 encryption scheme, the hashing algorithm, and the diffie-hellman group. The modp1024 is for Diffie-Hellman 2. Why 'modp' instead of dh? DH2 is a 1028 bit encryption algorithm that modulo's a prime number, e.g. modp1028. See RFC 5114 for details or the wiki page on diffie hellmann, if interested.

type=transport
#because we use l2tp as tunnel protocol

left=%SERVERIP%
#fill in server IP above

leftprotoport=17/1701
right=%any
rightprotoport=17/%any

dpddelay=10
# Dead Peer Dectection (RFC 3706) keepalives delay
dpdtimeout=20
#  length of time (in seconds) we will idle without hearing either an R_U_THERE poll from our peer, or an R_U_THERE_ACK reply.
dpdaction=clear
# When a DPD enabled peer is declared dead, what action should be taken. clear means the eroute and SA with both be cleared. ```
</code></pre></div> <p>修改 ipsec.secrets &gt;- 获取服务器 IP: <code class="highlighter-rouge">curl http://ip.mtak.nl</code> &gt;- 生成随机密匙: <code class="highlighter-rouge">openssl rand -hex 30</code></p> <p>设置IPSec握手时的的 Shared Secret,<code class="highlighter-rouge">/etc/ipsec.secrets</code>修改为 <code class="highlighter-rouge"> %SERVERIP% %any: PSK "%Shared Secret%" </code></p> <p>验证 IPSEC 是否正常工作 <code class="highlighter-rouge">ipsec verify</code></p> <p>遇到的问题 &gt;- <code class="highlighter-rouge">NETKEY: Testing XFRM related proc values [FAILED]</code>应该是忘记修改网络策略,解决方法</p> <div class="highlighter-rouge"><pre class="highlight"><code>for each in /proc/sys/net/ipv4/conf/*
do
    echo 0 &gt; $each/accept_redirects
    echo 0 &gt; $each/send_redirects
done
</code></pre></div> <blockquote> <ul> <li><code class="highlighter-rouge">Hardware RNG detected, testing if used properly [FAILED]</code> 解决方法</li> </ul> </blockquote> <div class="highlighter-rouge"><pre class="highlight"><code>sudo apt-get install rng-tools
</code></pre></div> <p>再次验证 IPSEC <code class="highlighter-rouge">ipsec verify</code>，终于正常。</p> <p>###配置 xl2tpd</p> <p><code class="highlighter-rouge">/etc/xl2tpd/xl2tpd.conf</code>修改成： ``` [global] ipsec saref = yes saref refinfo = 30</p> <p>;debug avp = yes ;debug network = yes ;debug state = yes ;debug tunnel = yes</p> <p>[lns default] ip range = 172.16.1.30-172.16.1.100 local ip = 172.16.1.1 refuse pap = yes require authentication = yes ;ppp debug = yes pppoptfile = /etc/ppp/options.xl2tpd length bit = yes ```</p> <p>###用户认证 编辑<code class="highlighter-rouge">/etc/xl2tpd/xl2tpd.conf</code> <code class="highlighter-rouge"> # 增加这一行： unix authentication = yes # 删除这一行 refuse pap = yes </code> 更改<code class="highlighter-rouge">/etc/pam.d/ppp</code>成: <code class="highlighter-rouge"> auth required pam_nologin.so auth required pam_unix.so account required pam_unix.so session required pam_unix.so </code> 修改 <code class="highlighter-rouge">/etc/ppp/options.xl2tpd</code> <code class="highlighter-rouge"> login ms-dns 8.8.8.8 ms-dns 8.8.4.4 auth mtu 1200 mru 1000 crtscts hide-password modem name l2tpd proxyarp lcp-echo-interval 30 lcp-echo-failure 4 </code></p> <p>##使用 ###增加用户 修改<code class="highlighter-rouge">/etc/ppp/chap-secrets</code> <code class="highlighter-rouge"> # Secrets for authentication using CHAP # client server secret IP addresses user1 l2tpd pass1 * user2 l2tpd pass2 * </code> ###重启服务 <code class="highlighter-rouge"> /etc/init.d/ipsec restart /etc/init.d/xl2tpd restart </code> ###查看错误日志 <code class="highlighter-rouge"> /var/log/syslog /var/log/auth.log </code></p> <p>[1] http://phyng.com/digitalocean-ubuntu-vpn.html [2] http://blog.fengqijun.me/vpn/2015/03/08/l2tp-ipsec-vpn-on-ubuntu-14/</p> </article> <div class="post-share"> <div class="container"> <a href="https://twitter.com/share?url=http://yourdomain.com/%E6%8A%80%E6%9C%AF/2015/10/12/build-v.html&text=v_p_n 架设" target="_blank" class="post-share-icon twitter"></a> <a href="https://www.evernote.com/clip.action?url=http://yourdomain.com/%E6%8A%80%E6%9C%AF/2015/10/12/build-v.html&title=v_p_n 架设" target="_blank" class="post-share-icon evernote"></a> <a href="http://service.weibo.com/share/share.php?url=http://yourdomain.com/%E6%8A%80%E6%9C%AF/2015/10/12/build-v.html&title=v_p_n 架设" target="_blank" class="post-share-icon weibo"></a> </div> </div> <div class="comment container"> <div id="disqus_thread"> <a href=""></a> </div> </div> <div class="footer"> <div class="container"> <p class="footer-entry">©2016 ♥ Mindy</p> <p class="footer-entry">Buit with <a href="http://jekyllrb.com/" target="_blank">Jekyll</a> • Hosted on <a href="https://pages.github.com/" target="_blank">Github</a></p> </div> </div> </main> <button id="menu"> <span id="menu-icons"></span> </button> <script src="/assets/js/jquery-2.1.3.min.js"></script> <script src="/assets/js/jquery.pjax.js"></script> <script src="/assets/js/nprogress.js"></script> <script src="/assets/js/main.js"></script> <script> (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){ (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o), m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m) })(window,document,'script','//www.google-analytics.com/analytics.js','ga'); ga('create', 'UA-46567212-3', 'auto'); ga('send', 'pageview'); </script> </body> </html>
